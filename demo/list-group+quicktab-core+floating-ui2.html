<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>下拉菜单+quicktab核心+tab的右键菜单+floating-ui的综合演示</title>
    <link rel="stylesheet" href="../dist/css/quicktab.css">
    <style>
        .q-tab-1 {
            padding: 30px;
            height: 300px;
            width: 800px;
        }
    </style>
</head>
<body>

<div class="quicktab reverse q-tab-1">
    <ul class="tab-bar">
        <li class="prev">
            <button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-left" viewBox="0 0 16 16">
                    <path d="M10 12.796V3.204L4.519 8 10 12.796zm-.659.753-5.48-4.796a1 1 0 0 1 0-1.506l5.48-4.796A1 1 0 0 1 11 3.204v9.592a1 1 0 0 1-1.659.753z"/>
                </svg>
            </button>
        </li>
        <li class="refresh">
            <button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
            </button>
        </li>
        <li class="scroll">
            <button><span>首页</span></button>
            <button><span>文章管理</span></button>
            <button class="active">
                <span>库存管理库存管理库存管理</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x"
                     viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>
            <button>
                <span>商品管理商品管理商品管理</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x"
                     viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>
            <button><span>tab1</span></button>
            <button><span>tab2</span></button>
            <button><span>tab3</span></button>
            <button><span>tab4</span></button>
            <button><span>tab5</span></button>
            <button><span>tab6</span></button>
            <button><span>tab7</span></button>
            <button><span>tab8</span></button>
            <button><span>tab9</span></button>
            <button><span>tab10</span></button>
            <button><span>tab11</span></button>
            <button><span>tab12</span></button>
            <button><span>tab13</span></button>
            <button><span>tab14</span></button>
            <button><span>tab15</span></button>
            <button><span>tab16</span></button>
            <button><span>tab17</span></button>
            <button><span>tab18</span></button>
            <button><span>tab19</span></button>
            <button><span>tab20</span></button>
            <button><span>tab21</span></button>
            <button><span>tab22</span></button>
            <button><span>tab23</span></button>
            <button><span>tab24</span></button>
            <button><span>tab25</span></button>
            <button><span>tab26</span></button>
            <button><span>tab27</span></button>
            <button><span>tab28</span></button>
            <button><span>tab29</span></button>
            <button><span>tab30</span></button>


        </li>
        <li class="next ">
            <button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-right" viewBox="0 0 16 16">
                    <path d="M6 12.796V3.204L11.481 8 6 12.796zm.659.753 5.48-4.796a1 1 0 0 0 0-1.506L6.66 2.451C6.011 1.885 5 2.345 5 3.204v9.592a1 1 0 0 0 1.659.753z"/>
                </svg>
            </button>
        </li>
        <li class="dropdown">
            <button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-caret-down" viewBox="0 0 16 16">
                    <path d="M3.204 5h9.592L8 10.481 3.204 5zm-.753.659 4.796 5.48a1 1 0 0 0 1.506 0l4.796-5.48c.566-.647.106-1.659-.753-1.659H3.204a1 1 0 0 0-.753 1.659z"/>
                </svg>
            </button>
        </li>
        <li class="fullscreen">
            <button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-fullscreen" viewBox="0 0 16 16">
                    <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                </svg>
            </button>
        </li>
    </ul>
    <!--  面板容器  -->
    <div class="tab-body">
        <div class="tab-body-item">
            <div class="mask">
                <div class="mask-inner">
                    <div class="quicktab-loaders">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
            </div>
            <iframe src="page.html"></iframe>
        </div>
        <div class="tab-body-item active">
            <!--<div class="mask">-->
            <!--    <div class="mask-inner">-->
            <!--        <div class="quicktab-loaders">-->
            <!--            <div></div>-->
            <!--            <div></div>-->
            <!--            <div></div>-->
            <!--        </div>-->
            <!--    </div>-->
            <!--</div>-->
            <iframe src="page2.html"></iframe>
        </div>
    </div>
</div>


<!--下拉菜单-->
<ul class="quicktab-list-group dropdown">
    <li>
        <span>关闭当前</span>
    </li>
    <li>
        <span>关闭其它</span>
    </li>
    <li>
        <span>关闭左侧</span>
    </li>
    <li>
        <span>关闭右侧</span>
    </li>
    <li>
        <span>关闭全部</span>
    </li>
    <li class="separator"></li>
    <li>
        <span>重新加载</span>
    </li>
    <li>
        <span>回到当前</span>
    </li>
    <li>
        <span>新窗口打开</span>
    </li>
</ul>


<!--tab右键菜单-->
<ul class="quicktab-list-group contextmenu">
    <li>
        <span>关闭当前</span>
    </li>
    <li>
        <span>关闭其它</span>
    </li>
    <li>
        <span>关闭左侧</span>
    </li>
    <li>
        <span>关闭右侧</span>
    </li>
    <li>
        <span>关闭全部</span>
    </li>
    <li class="separator"></li>
    <li class="refresh-item">
        <span>重新加载</span>
    </li>
    <li>
        <span>回到当前</span>
    </li>
    <li>
        <span>新窗口打开</span>
    </li>
</ul>


<script src="../vendor/quickquery/dist/quickquery.js"></script>


<script type="module">



    import {
        computePosition,
        flip,
        shift,
        offset,
        arrow,
        autoUpdate
    } from 'https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.5.3/+esm';
    import utils from "../src/utils";


    //容器
    const container = document.querySelector('.quicktab');


    //下拉菜单触发按钮
    const button = document.querySelector('.quicktab .tab-bar li.dropdown>button');
    const tooltip = document.querySelector('.quicktab-list-group.dropdown');


    let tabEl = null;
    const contextmenuMenuEl = document.querySelector('.quicktab-list-group.contextmenu');
    const tabSelector = '.quicktab .tab-bar li.scroll button';
    const tabCleanupKey = 'cleanup';


    // 自动更新的抽离程序
    function update(referenceElement, floatingElement) {
        computePosition(referenceElement, floatingElement, {
            placement: 'top',
            strategy: 'fixed',// 默认是'absolute'
            middleware: [
                offset(3),//offset(6)必须放在数组最前面，官方文档提示
                flip(),
                shift({padding: 10}),
                // arrow({element: arrowElement})
            ],
        }).then(({x, y, placement, middlewareData}) => {
            Object.assign(floatingElement.style, {
                left: `${x}px`,
                top: `${y}px`,
            });
        });
    }

    function updateContextmenuMenu() {
        update(tabEl, contextmenuMenuEl);
    }

    function contextmenuMenuAutoUpdate() {
        if (!tabEl.getAttribute(tabCleanupKey)) {
            const cleanup = autoUpdate(
                tabEl,
                contextmenuMenuEl,
                updateContextmenuMenu
            );
            tabEl.setAttribute(tabCleanupKey, cleanup)
        }
    }


    function showContextmenuMenu() {
        updateContextmenuMenu();
        contextmenuMenuEl.style.display = 'block';
        container.classList.add('contextmenu-open');
    }


    function hideContextmenuMenu() {
        contextmenuMenuEl.style.display = '';
        container.classList.remove('contextmenu-open');
    }


    function updateMoreMenu() {
        update(button, tooltip)
    }


    function showMoreMenu() {
        tooltip.style.display = 'block';
        updateMoreMenu();


        //同时给iframe窗口禁用所有的鼠标事件
        container.classList.add('dropdown-open');
    }

    function hideMoreMenu() {
        tooltip.style.display = '';
        container.classList.remove('dropdown-open');
    }


    // 改函数在dom从窗口删除时调用
    const cleanup = autoUpdate(
        button,
        tooltip,
        updateMoreMenu
    );


    function isContextmenuMenuShow() {
        return window.getComputedStyle(contextmenuMenuEl).display === 'none'
    }

    function isMoreMenuShow() {
        return window.getComputedStyle(tooltip).display === 'none'
    }


    //触发事件
    quickquery(document).on('click', function (event) {
        const target = event.target;

        if (!isContextmenuMenuShow()) {
            hideContextmenuMenu();
        }

        if (target.closest('.quicktab .tab-bar li.dropdown>button')) {//是点击触发按钮
            // 你的触发事件代码
            if (isMoreMenuShow()) {
                showMoreMenu();
            } else {
                hideMoreMenu();
            }
        } else if (target.closest('.quicktab-list-group.dropdown')) {
            hideMoreMenu();
        } else {

            if (!isMoreMenuShow()) {
                hideMoreMenu();
            }
        }
    });


    quickquery('.prev').on('click', function () {
        const scroll = document.querySelector('.tab-bar li.scroll');

        scroll.scrollTo({
            left: scroll.scrollLeft - scroll.offsetWidth,
            behavior: 'smooth'
        })
    })


    quickquery('.next').on('click', function () {
        const scroll = document.querySelector('.tab-bar li.scroll');

        scroll.scrollTo({
            left: scroll.scrollLeft + scroll.offsetWidth,
            behavior: 'smooth'
        })

    })


    quickquery(tabSelector).on('contextmenu', function (event) {
        event.preventDefault();
        tabEl = this;
        //显示tab的右键菜单
        showContextmenuMenu();

        //注册自动更新位置
        contextmenuMenuAutoUpdate();

        //关闭更多下拉菜单
        hideMoreMenu();
    })


    //鼠标任意地方右键，需要关闭tab右键菜单，和更多下拉菜单
    quickquery(document).on('contextmenu', function (event) {
        if (!event.target.closest(tabSelector)) {
            hideContextmenuMenu()
        }

        if (!isMoreMenuShow()) {
            hideMoreMenu();
        }

    })


    //窗口大小改变也要及时关闭右键菜单
    quickquery(window).on('resize', utils.debounce(function () {
        if (!isContextmenuMenuShow()) {
            hideContextmenuMenu();
        }

        if (!isMoreMenuShow()) {
            hideMoreMenu();
        }
    }, 300))


    //tab菜单的item的单击事件处理
    quickquery(contextmenuMenuEl).on('click', '.refresh-item', function (event) {
        event.stopPropagation();
        console.log('click');
    })

    quickquery(contextmenuMenuEl).on('contextmenu', '.refresh-item', function (event) {
        event.stopPropagation();
        event.preventDefault();
        console.log('contextmenu');
    })


    //触摸开始事件
    // quickquery('.quicktab').on('touchstart',  function () {
    //     console.log('touchstart');
    // })


    quickquery('.quicktab')[0].addEventListener('touchstart', function(event) {
        // 处理事件的回调函数
        console.log('touchstart');
    }, {passive: false});


</script>

</body>
</html>
